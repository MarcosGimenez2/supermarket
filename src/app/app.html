<body [class.dark-mode]="isDarkMode">
  <header>
    <i class="fa fa-cart-plus text-black" aria-hidden="true"></i>
    <h1 class="text-black">SuperMarket</h1>

    <button id="ponto" (click)="toggleExplanation()" title="Help">
      <i class="fa fa-question-circle"></i>
    </button>

    <button id="noite" (click)="toggleDarkMode()" title="Trade">
      <i class="fa" [ngClass]="isDarkMode ? 'fa-sun' : 'fa-moon'"></i>
    </button>

    <div *ngIf="showExplanation" class="explanation-popup">
      <p>This is your supermarket cart. Here you can add, edit, and remove products.</p>
      <button id="fechar" (click)="toggleExplanation()">Fechar</button>
    </div>
  </header>

  <div *ngIf="successNotification" class="toast-notification">
    {{ successNotification }}
  </div>

  <!-- Avatar fixo no canto superior direito -->
  <div class="user-wrapper" (click)="toggleMostrarEmail()" title="Usuário">
    <img
      *ngIf="fotoPerfil; else iconeUsuario"
      [src]="fotoPerfil"
      alt="Foto de perfil"
      class="avatar-img"
    />

    <ng-template #iconeUsuario>
      <i class="fa fa-user-circle fa-2x text-white"></i>
    </ng-template>

    <div
      class="email-popup"
      *ngIf="mostrarEmail"
      (click)="$event.stopPropagation()"
    >
      <div class="email-camera-container">
        <div class="camera-wrapper" (click)="abrirSeletorFoto($event)">
          <img
            *ngIf="fotoPerfil; else iconeCamera"
            [src]="fotoPerfil"
            class="camera-preview"
            alt="Foto de perfil"
          />
          <ng-template #iconeCamera>
            <i class="fa fa-camera fa-3x camera-icon" title="Mudar foto de perfil"></i>
          </ng-template>
        </div>
        <span>
          <h5 class="fw-bold">UserName</h5>
          <p class="email-text">usuario@msc.com</p>
        </span>
       
     <!-- Conteúdo atual do popup -->
</div>

      </div>

      <input
        type="file"
        id="fotoInput"
        (change)="carregarFoto($event)"
        hidden
        accept="image/*"
      />
    </div>
  

  <main class="container text-center">
    <h3 class="fw-bold">Include New Product</h3>

    <form #productForm="ngForm" class="mb-4">
      <input
        type="text"
        class="form-control"
        [(ngModel)]="currentProduct.name"
        name="name"
        required
        placeholder="Name"
      />

      <input
        type="text"
        class="form-control"
        [(ngModel)]="currentProduct.ammount"
        name="ammount"
        required
        placeholder="R$ 0,00"
        mask="separator.2"
        prefix="R$"
        thousandSeparator="."
        decimalMarker=","
      />

      <input
        type="number"
        class="form-control"
        [(ngModel)]="currentProduct.quantity"
        name="quantity"
        required
        placeholder="Quantity"
      />

      <div class="col-auto">
        <button
          type="button"
          class="btn btn-success"
          title="Adicionar"
          [disabled]="!productForm.form.valid"
          (click)="addProduct()"
        >
          <i class="fa fa-plus"></i>Add
        </button>
      </div>
    </form>

    <div *ngIf="successMessage" class="alert alert-success text-center">
      {{ successMessage }}
    </div>

    <!--Tabela Produtos -->
    <div *ngIf="lstproducts.length > 0" class="table-responsive rounded">
      <table id="tableToDownload" class="table table-dark table-hover">
        <thead class="table-secondary">
          <tr>
            <th style="width: 5%;">
              <input
                type="checkbox"
                [(ngModel)]="selectAll"
                (change)="toggleSelectAll()"
              />
            </th>
            <th style="width: 30%;">Name</th>
            <th
              style="width: 20%; cursor: pointer;"
              (click)="ordenarPorPreco()"
            >
              Ammount
              <i
                class="fa"
                [ngClass]="sortAscending ? 'fa-sort-amount-up' : 'fa-sort-amount-down'"
              ></i>
            </th>
            <th style="width: 20%;">Quantity</th>
            <th style="width: 10%;">
              <button
                type="button"
                class="btn btn-primary btn-sm"
                (click)="downloadTableAsImage()"
                title="Baixar tabela como imagem"
              >
                <i class="fa fa-download"></i>
              </button>
            </th>
          </tr>
        </thead>

        <tbody>
          <tr *ngFor="let product of lstproducts; let i = index">
            <td>
              <input
                type="checkbox"
                [(ngModel)]="product.selected"
                (change)="onToggleIndividual()"
              />
            </td>

            <td>
              <span *ngIf="editIndex !== i">{{ product.name }}</span>
              <input
                *ngIf="editIndex === i"
                type="text"
                [(ngModel)]="editProduct.name"
                class="form-control"
              />
              <small *ngIf="editErrorMessages[i]" class="text-danger">
                {{ editErrorMessages[i] }}
              </small>
            </td>

            <td>
              <span *ngIf="editIndex !== i">
                {{ product.ammount | currency: 'BRL': 'symbol': '1.1-2' }}
              </span>
              <input
                *ngIf="editIndex === i"
                type="text"
                [(ngModel)]="editProduct.ammount"
                mask="separator.2"
                prefix="R$"
                thousandSeparator="."
                decimalMarker=","
                [dropSpecialCharacters]="true"
                class="form-control"
              />
            </td>

            <td>
              <span *ngIf="editIndex !== i">{{ product.quantity }}</span>
              <input
                *ngIf="editIndex === i"
                type="number"
                [(ngModel)]="editProduct.quantity"
                class="form-control"
              />
            </td>

            <td>
              <button
                type="button"
                class="btn btn-sm"
                [ngClass]="editIndex === i ? 'btn-success' : 'btn-warning'"
                (click)="ToggleEdit(i)"
              >
                <i
                  [class]="
                    editIndex === i ? 'fa-solid fa-save' : 'fa-solid fa-pen'
                  "
                ></i>
              </button>

              <button
                type="button"
                class="btn btn-danger btn-sm ms-2"
                (click)="DeleteProduct(i)"
              >
                <i class="fa-solid fa-trash"></i>
              </button>
            </td>
          </tr>

          <!-- Linha para a logo MSC quando não tem produtos -->
          <tr *ngIf="lstproducts.length === 0">
            <td colspan="3"></td>
            <td class="text-center"></td>
          </tr>
        </tbody>

        <tfoot *ngIf="getProdutosSelecionados().length > 0">
          <tr class="table-secondary  text-center">
            <th></th>
            <th></th>
            <th>
              Total Expense:
              {{ getTotalSelecionado() | currency: 'BRL': 'symbol': '1.2-2' }}
            </th>
            <th colspan="1">Total Quantity: {{ getQuantidadeSelecionada() }}</th>
            <th>
              <button
                class="btn btn-danger btn-sm"
                (click)="deleteSelected()"
                title="Apagar todos selecionados"
              >
                <i class="fa fa-trash"></i>
              </button>
            </th>
          </tr>
          <tr class="table-secondary text-center ">
            <td colspan="5">
              <button id="final" class="btn btn-primary fw-bold" (click)="abrirModalFrete()">
               Complete Purchase
              </button>
            </td>
          </tr>
        </tfoot>
      </table>
    </div>
  </main>

  <div class="modal-backdrop" *ngIf="mostrarModalFrete">
    <div class="modal-content">
      <h3>Enter your ZIP code for delivery</h3>

      <!-- Campo de CEP -->
      <input
        type="text"
        [(ngModel)]="cepDigitado"
        (ngModelChange)="onCepChange()"
        placeholder="Ex: 01001-000"
        mask="00000-000"
        maxlength="9"
        autofocus
        (input)="onCepChange()"
      />

      <p *ngIf="cepInvalido" style="color: red; margin-top: 5px;">
        Invalid ZIP code. Please check.
      </p>

      <!-- Endereço -->
      <div *ngIf="endereco" class="endereco-info">
        <p><strong>Address:</strong> {{ endereco }}</p>
      </div>

      <!-- Preços -->
      <div *ngIf="valorFrete !== null" class="frete-result">
        <p><strong>Freight:</strong> {{ valorFrete | currency: 'BRL': 'symbol' }}</p>
        <p id="fretes">Free Shipping from R$20.00.</p>
        <br />
        <p class="total-final">
          <strong>Total with shipping:</strong> {{ totalComFrete | currency: 'BRL': 'symbol' }}
        </p>
      </div>

      <!-- Botões -->
      <div class="modal-buttons">
        <button class="confirmar" (click)="confirmarCompra()" [disabled]="valorFrete === null">
          Confirm Purchase
        </button>
        <button class="cancelar" (click)="fecharModalFrete()">Cancel</button>
      </div>
    </div>
  </div>
</body>
